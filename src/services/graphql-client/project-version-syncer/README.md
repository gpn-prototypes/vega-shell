[apollolink]: https://www.apollographql.com/docs/react/api/link/introduction/
[current-project]: ../../current-project/README.md
[message-bus]: ../../message-bus/README.md

# Синхронизация версии проекта

## Мотивация

Запросы на разные части проекта могут происходить в разное время, а значит, что версия между запросами может меняться.
Чтобы не хранить несколько версий проекта на клиенте, необходимо иметь механизм,
который будет держать проект в актуальном состоянии.

## Реализация

Механизм основан на [ApolloLink][apollolink].
Если в момент запроса активен проект в [CurrentProject][current-project], то такие запросы добавляются в список отслеживаемых.
После выполнения запроса ответ проверяется на наличие новых данных о текущем проекте.
Если в ответе такие данные есть, то все отслеживаемые запросы готовятся на перезапрос.
При подготовке на перезапрос мы отсеиваем все запросы, которые больше не находятся
в кэше `ApolloClient` (считаем, что клиенту нужны только те данные, которые есть в кэше),
и убираем эти запросы из отслеживаемых.

В случае получения обновленного проекта в [CurrentProject][current-project] обновляется его версия.

### Пример работы

```tsx
const [mutate] = useMutation({ query: SomeProjectMutation });

async function handleProjectChange() {
  await mutate(); // Promise выполнится, когда отработает мутация и все необходимые перезапросы
}
```

> Чтобы исключить случай с бесконечными перезапросами, сделано ограничение в 10 попыток.
> Если за это количество попыток не получится синхронизировать версию проекта, то `mutate` завершится с исключением.

## Интеграция

Для всех отслеживаемых `Query` должна быть
указана [политика](https://www.apollographql.com/docs/react/data/queries/#setting-a-fetch-policy) `"cache-first"`.

Если клиент используется напрямую (не через `useQuery`),
то метод `graphqlClient.query` нужно заменить на `graphqlClient.watchQuery`,
чтобы получать обновления данных.

### Запросы на `/graphql`

Ко всем запросам данных о проекте необходимо добавлять поля `vid` и `version`.

### Запросы на `/graphql/:project_vid`

Необходимо добавить корневые `__typename`

```gql
query SomeQuery {
  __typename # Query
}

mutation SomeMutation {
  __typename # Mutation
}
```

В ответе на мутацию необходимо запросить итоговую версию

```gql
mutation UpdateProject {
  project
  version # ВАЖНО указать в самом конце!
}
```
